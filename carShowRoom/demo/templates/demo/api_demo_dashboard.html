{% extends 'demo/base.html' %}
{% block content %}
<h1>Car Dealer Dashboard</h1>
<button id="loadCars">Load Cars</button>
<p id="status"></p> <!-- üëà status message placeholder -->
<table id="carsTable" border="1"></table>

<script>
  async function login() {
    const res = await fetch("/api/token/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({username: "kook", password: "-123-123"})
    });

    if (!res.ok) {
      console.error("Login failed:", res.status);
      return null;
    }

    const data = await res.json();
    if (!data.access) {
      console.error("No access token:", data);
      return null;
    }

    return data.access;
  }

  async function loadCars() {
    const status = document.getElementById("status");
    const table = document.getElementById("carsTable");

    // Reset UI
    table.innerHTML = "";
    status.textContent = "üîÑ Loading cars...";

    const token = await login();
    if (!token) {
      status.textContent = "‚ùå Login failed ‚Äî please check your credentials.";
      return;
    }

    try {
      const res = await fetch("/api/cars/", {
        headers: {"Authorization": `Bearer ${token}`}
      });

      if (!res.ok) {
        status.textContent = `‚ö†Ô∏è Error fetching cars: ${res.status}`;
        return;
      }

      const cars = await res.json();

      // Update the table
      if (cars.results && cars.results.length > 0) {
        table.innerHTML = "<tr><th>ID</th><th>Name</th><th>Brand</th></tr>" +
          cars.results.map(c => `<tr><td>${c.id}</td><td>${c.nama}</td><td>${c.merek}</td></tr>`).join("");
        status.textContent = "‚úÖ Cars loaded successfully.";
      } else {
        status.textContent = "‚ÑπÔ∏è No cars found.";
      }
    } catch (error) {
      console.error(error);
      status.textContent = "‚ùå Network error ‚Äî please try again.";
    }
  }

  document.getElementById("loadCars").addEventListener("click", loadCars);
</script>

{% endblock content %}

{% extends "demo/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h3 class="m-0 fw-bold text-dark">ðŸ“Š Executive Dashboard</h3>
            <p class="text-muted m-0">
                Performance for 
                {% if selected_month %}
                    <strong>{{ selected_month|date:"F" }} {{ selected_year }}</strong> (Daily View)
                {% else %}
                    <strong>{{ selected_year }}</strong> (Monthly View)
                {% endif %}
            </p>
        </div>

        <form method="get" class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
            
            <div class="d-flex align-items-center">
                <label class="me-2 text-muted small fw-bold d-none d-sm-block">Month:</label>
                <select name="month" class="form-select form-select-sm border-0 bg-light fw-bold" onchange="this.form.submit()" style="cursor: pointer;">
                    <option value="">All Months</option>
                    {% for m in month_list %}
                        <option value="{{ m.num }}" {% if m.num == selected_month %}selected{% endif %}>
                            {{ m.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="vr"></div> 
            
            <div class="d-flex align-items-center">
                <label class="me-2 text-muted small fw-bold d-none d-sm-block">Year:</label>
                <select name="year" class="form-select form-select-sm border-0 bg-light fw-bold" onchange="this.form.submit()" style="cursor: pointer;">
                    {% for y in available_years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-primary h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1 text-uppercase fw-bold">Total Orders</p>
                    <h4 class="mb-0 fw-bold text-primary">{{ total_order }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-success h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1 text-uppercase fw-bold">Total Income (Deal)</p>
                    <h4 class="mb-0 fw-bold text-success">Rp {{ total_income|intcomma }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-danger h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1 text-uppercase fw-bold">Sell Orders (In)</p>
                    {% with total_sell=0 %}
                        <h4 class="mb-0 fw-bold text-danger">Check Chart ðŸ‘‡</h4>
                    {% endwith %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-secondary h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1 text-uppercase fw-bold">Total Cars Stock</p>
                    <h4 class="mb-0 fw-bold text-secondary">{{ total_cars }}</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-chart-line me-2 text-primary"></i> Sales & Acquisition Trend</h5>
                    <span class="badge bg-light text-dark border">
                        {% if selected_month %}Daily Breakdown{% else %}Monthly Breakdown{% endif %}
                    </span>
                </div>
                <div class="card-body">
                    <div style="height: 350px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-trophy me-2 text-warning"></i> Best Selling Brands</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="salesBrandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-users me-2 text-info"></i> Customer Status Funnel</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px; width: 100%; display: flex; justify-content: center;">
                        <canvas id="customerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. DYNAMIC TREND CHART (Multi-Line) ---
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            // Label Waktu (Dinamis: Tanggal 1-31 atau Bulan Jan-Dec)
            labels: [{% for data in trend_data %}"{{ data.period|date:date_format_code }}",{% endfor %}],
            datasets: [
                {
                    label: 'Total Orders (All Types)',
                    data: [{% for data in trend_data %}{{ data.total_all }},{% endfor %}],
                    borderColor: '#0d6efd', // Biru
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Sell Orders (Incoming Cars)',
                    data: [{% for data in trend_data %}{{ data.total_sell }},{% endfor %}],
                    borderColor: '#dc3545', // Merah
                    backgroundColor: 'rgba(220, 53, 69, 0.0)', // Transparan
                    borderWidth: 2,
                    borderDash: [5, 5], // Garis putus-putus untuk membedakan
                    tension: 0.3,
                    pointStyle: 'rectRot'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // --- 2. TOP SELLING BRANDS (Bar Chart) ---
    const ctxBrand = document.getElementById('salesBrandChart').getContext('2d');
    new Chart(ctxBrand, {
        type: 'bar',
        data: {
            labels: [{% for item in top_selling_brands %}"{{ item.showroom_car__merek }}",{% endfor %}],
            datasets: [{
                label: 'Units Sold/Ordered',
                data: [{% for item in top_selling_brands %}{{ item.total_sold }},{% endfor %}],
                backgroundColor: [
                    '#ffc107', '#fd7e14', '#20c997', '#0dcaf0', '#6610f2'
                ],
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Horizontal Bar
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });

    // --- 3. CUSTOMER STATUS (Doughnut) ---
    const ctxCustomer = document.getElementById('customerChart').getContext('2d');
    new Chart(ctxCustomer, {
        type: 'doughnut',
        data: {
            labels: [{% for c in customer_status_data %}"{{ c.status|title }}",{% endfor %}],
            datasets: [{
                data: [{% for c in customer_status_data %}{{ c.total }},{% endfor %}],
                backgroundColor: ['#198754', '#ffc107', '#dc3545', '#6c757d', '#0dcaf0'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: { legend: { position: 'right' } }
        }
    });
});
</script>

{% endblock %}
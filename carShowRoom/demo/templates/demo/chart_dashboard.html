{% extends "demo/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="m-0 fw-bold text-dark">ðŸ“Š Executive Dashboard</h3>
            <p class="text-muted m-0">Performance overview for <strong>{{ selected_year }}</strong></p>
        </div>

        <form method="get" class="d-flex align-items-center bg-white p-2 rounded shadow-sm border">
            <label for="year" class="me-2 text-muted small fw-bold"><i class="fas fa-calendar-alt"></i> Year:</label>
            <select name="year" id="year" class="form-select form-select-sm border-0 bg-light fw-bold" 
                    onchange="this.form.submit()" style="cursor: pointer;">
                {% for y in available_years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1 text-uppercase fw-bold">Total Orders</p>
                            <h4 class="mb-0 fw-bold text-primary">{{ total_order }}</h4>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary"><i class="fas fa-shopping-cart fa-lg"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1 text-uppercase fw-bold">Total Income (Deal)</p>
                            <h4 class="mb-0 fw-bold text-success">Rp {{ total_income|intcomma }}</h4>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success"><i class="fas fa-money-bill-wave fa-lg"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1 text-uppercase fw-bold">Customers</p>
                            <h4 class="mb-0 fw-bold text-warning">{{ total_customer }}</h4>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="fas fa-users fa-lg"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 border-start border-4 border-secondary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted small mb-1 text-uppercase fw-bold">Cars Available</p>
                            <h4 class="mb-0 fw-bold text-secondary">{{ total_cars }}</h4>
                        </div>
                        <div class="bg-secondary bg-opacity-10 p-3 rounded-circle text-secondary"><i class="fas fa-car fa-lg"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-chart-line me-2 text-primary"></i> Monthly Sales Trend</h5>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="orderChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        
        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-car me-2 text-secondary"></i> Inventory by Brand (Top 10)</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-filter me-2 text-warning"></i> Customer Status Funnel</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px; width: 100%; display: flex; justify-content: center;">
                        <canvas id="customerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. Sales Trend Chart (Line) ---
    const ctxOrder = document.getElementById('orderChart').getContext('2d');
    new Chart(ctxOrder, {
        type: 'line',
        data: {
            labels: [{% for data in order_per_month %}"{{ data.month|date:'M' }}",{% endfor %}],
            datasets: [{
                label: 'Sales Orders',
                data: [{% for data in order_per_month %}{{ data.total }},{% endfor %}],
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderColor: '#0d6efd',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // --- 2. Car Brand Chart (Bar) ---
    const ctxBrand = document.getElementById('brandChart').getContext('2d');
    new Chart(ctxBrand, {
        type: 'bar',
        data: {
            labels: [{% for car in car_brand_data %}"{{ car.merek }}",{% endfor %}],
            datasets: [{
                label: 'Total Units',
                data: [{% for car in car_brand_data %}{{ car.total }},{% endfor %}],
                backgroundColor: [
                    '#6610f2', '#6f42c1', '#d63384', '#dc3545', 
                    '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                ],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Membuat bar chart jadi horizontal agar nama merek terbaca jelas
            scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });

    // --- 3. Customer Status Chart (Doughnut) ---
    const ctxCustomer = document.getElementById('customerChart').getContext('2d');
    new Chart(ctxCustomer, {
        type: 'doughnut',
        data: {
            labels: [{% for c in customer_status_data %}"{{ c.status|title }}",{% endfor %}],
            datasets: [{
                data: [{% for c in customer_status_data %}{{ c.total }},{% endfor %}],
                backgroundColor: [
                    '#198754', // Deal (Hijau)
                    '#ffc107', // Negotiating (Kuning)
                    '#dc3545', // Uncontacted (Merah)
                    '#6c757d', // Others (Abu)
                    '#0dcaf0'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%', // Lubang tengah donat
            plugins: {
                legend: { position: 'right' }
            }
        }
    });

});
</script>

{% endblock %}
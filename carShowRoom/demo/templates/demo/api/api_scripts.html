<script>
/* ============================================================
   UTIL: Determine which response panel to show
   ============================================================ */
function getTargetByEndpoint(endpoint) {
    if (endpoint.startsWith('/api/customers/')) return 'customersResponse';
    if (endpoint.startsWith('/api/cars/')) return 'carsResponse';
    if (endpoint.startsWith('/api/orders/')) return 'ordersResponse';
    return null;
}

{% comment %} function showResponse(targetId, data, status = 200) {
    const pre = document.getElementById(targetId);
    if (!pre) return;

    pre.textContent = "HTTP " + status + "\n\n" + JSON.stringify(data, null, 4);
} {% endcomment %}

{% comment %} function showResponse(targetId, data, status = 200) {

    // Make the correct response box visible
    const container = document.getElementById(targetId + "Container");
    if (container) container.classList.remove("d-none");

    const pre = document.getElementById(targetId);
    if (!pre) return;

    pre.textContent = "HTTP " + status + "\n\n" + JSON.stringify(data, null, 4);
} {% endcomment %}

function showResponse(targetId, data, status = 200) {
    const pre = document.getElementById(targetId);
    if (!pre) return;

    pre.textContent = "HTTP " + status + "\n\n" + JSON.stringify(data, null, 4);
}


/* ============================================================
   TOKEN HANDLING
   ============================================================ */
function setTokenFrom(access, refresh = null) {

    const accessBox = document.getElementById("activeToken");
    const refreshBox = document.getElementById("refreshTokenDisplay");

    if (!access) {
        accessBox.textContent = "No access token";
        refreshBox.textContent = "No refresh token";
        return;
    }

    accessBox.textContent = access.startsWith("Bearer") ? access : "Bearer " + access;

    if (refresh) {
        refreshBox.textContent = refresh;
        localStorage.setItem("api_demo_refresh", refresh);
    } else {
        const saved = localStorage.getItem("api_demo_refresh");
        refreshBox.textContent = saved || "No refresh token";
    }
}


function copyToken() {
    navigator.clipboard.writeText(document.getElementById('activeToken').textContent);
    alert("Token copied to clipboard");
}

function clearToken() {
    setTokenFrom(null);
    localStorage.removeItem('api_demo_access');
    localStorage.removeItem('api_demo_refresh');

    const badge = document.getElementById("tokenRefreshedBadge");
    if (badge) badge.style.display = "none";
}

function useDemoToken() {
    setTokenFrom("demo-token-123");
}



/* ============================================================
   AUTH: Obtain JWT token
   ============================================================ */
async function obtainToken() {
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;

    const res = await fetch("/api/token/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (res.ok) {
        setTokenFrom(data.access, data.refresh);

        // Autofill the refresh token input box
        const rt = document.getElementById("refreshTokenInput");
        if (rt && data.refresh) rt.value = data.refresh;

        alert("Token obtained.");
    } else {
        alert("Login failed: " + JSON.stringify(data));
    }
}

/* ============================================================
   AUTH: Refresh Token
   ============================================================ */
async function refreshToken() {
    let refresh = document.getElementById("refreshTokenInput").value.trim();

    // If user pasted "Bearer <token>" â†’ strip "Bearer "
    if (refresh.toLowerCase().startsWith("bearer ")) {
        refresh = refresh.slice(7);  // remove "Bearer "
    }

    if (!refresh) return alert("Paste refresh token first.");

    const res = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
    });

    const data = await res.json();

    if (res.ok) {
        setTokenFrom(data.access, data.refresh || null);
        alert("Token refreshed.");

        showTokenRefreshedBadge();

    } else {
        alert("Refresh failed: " + JSON.stringify(data));
    }
}


function copyAccessToken() {
    const t = document.getElementById("activeToken").textContent.trim();
    navigator.clipboard.writeText(t);
    alert("Access token copied");
}

function copyRefreshToken() {
    const t = document.getElementById("refreshTokenDisplay").textContent.trim();
    navigator.clipboard.writeText(t);
    alert("Refresh token copied");
}


/* ============================================================
   UTIL: Build request headers
   ============================================================ */
function getAuthHeaders() {
    const headers = { "Content-Type": "application/json" };
    const token = document.getElementById("activeToken").textContent;

    if (token.startsWith("Bearer ") && !token.includes("(no token)")) {
        headers["Authorization"] = token;
    }
    return headers;
}



/* ============================================================
   GENERIC API CALL
   ============================================================ */
async function tryApi(method, endpoint, body = null, overrideTarget = null) {
    const headers = getAuthHeaders();

    const res = await fetch(endpoint, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
    });

    let data;
    try {
        data = await res.json();
    } catch {
        data = { error: "Non-JSON response" };
    }

    const target = overrideTarget || getTargetByEndpoint(endpoint);
    if (target) showResponse(target, data, res.status);

    return { ok: res.ok, status: res.status };
}


/* ============================================================
   API CALL WITH ID
   ============================================================ */
function tryApiWithId(method, base, id, suffix = '/') {
    if (!id) return alert("Please provide an ID");
    const endpoint = base + id + suffix;
    return tryApi(method, endpoint);
}

/* ============================================================
   CUSTOMERS: Create
   ============================================================ */
async function createCustomer() {
    const body = {
        name: document.getElementById("cust_name").value,
        email: document.getElementById("cust_email").value,
        phone: document.getElementById("cust_phone").value,
    };
    await tryApi("POST", "/api/customers/", body);
}

async function getCustomersIds() {
    await tryApi("GET", "/api/customers/");
}

/* ============================================================
   CARS: Create
   ============================================================ */
async function createCar() {
    const body = {
        name: document.getElementById("car_name").value,
        price: parseFloat(document.getElementById("car_price").value || 0),
        status: document.getElementById("car_status").value
    };

    await tryApi("POST", "/api/cars/", body);
}


/* ============================================================
   ORDERS: Create
   ============================================================ */
async function createOrder() {
    let items;
    try {
        items = JSON.parse(document.getElementById("order_items").value);
    } catch {
        return alert("Items must be valid JSON");
    }

    const body = {
        customer: document.getElementById("order_customer").value,
        items: items,
        total: parseFloat(document.getElementById("order_total").value || 0),
    };

    await tryApi("POST", "/api/orders/", body);
}

/* ============================================================
   EDIT (PUT) MODAL: Open modal with dynamic fields
   ============================================================ */
async function openEditModalFor(base, id) {
    if (!id) return alert("Please enter ID first");

    const endpoint = base + id + "/";

    // Fetch existing resource
    const res = await fetch(endpoint, { headers: getAuthHeaders() });
    const data = await res.json();

    // Build form fields dynamically
    const container = document.getElementById("editFields");
    container.innerHTML = ""; // clear

    Object.entries(data).forEach(([key, value]) => {
        // skip nested objects
        if (typeof value === "object" && value !== null) return;

        const type = typeof value === "number" ? "number" : "text";
        container.innerHTML += `
            <div class="mb-2">
                <label class="form-label">${key}</label>
                <input class="form-control"
                       data-key="${key}"
                       type="${type}"
                       value="${value ?? ''}" />
            </div>
        `;
    });

    // set hidden fields
    document.getElementById("edit_endpoint").value = base;
    document.getElementById("edit_id").value = id;

    // show modal
    const modal = new bootstrap.Modal(document.getElementById("editModal"));
    modal.show();
}

/* ============================================================
   EDIT (PUT): Submit modal changes
   ============================================================ */
async function submitEdit() {
    const endpoint = document.getElementById("edit_endpoint").value;
    const id = document.getElementById("edit_id").value;
    const inputs = document.querySelectorAll("#editFields [data-key]");
    const body = {};

    inputs.forEach(input => {
        const key = input.getAttribute("data-key");
        let val = input.value;

        if (input.type === "number") val = parseFloat(val);

        try {
            body[key] = JSON.parse(val);
        } catch {
            body[key] = val;
        }
    });

    await tryApi("PUT", endpoint + id + "/", body);

    // Close modal
    const modalObj = bootstrap.Modal.getInstance(document.getElementById("editModal"));
    if (modalObj) modalObj.hide();
}

/* ============================================================
   INIT: Restore token if saved
   ============================================================ */
(function init() {
    const access = localStorage.getItem("api_demo_access");
    const refresh = localStorage.getItem("api_demo_refresh");

    if (access) {
        setTokenFrom(access, refresh);
    }
})();


/* ============================================================
   Get user profile
   ============================================================ */
async function getProfile() {
    await tryApi("GET", "/api/user/profile/", null, "authResponse");
}


/* ============================================================
   Color animation access token text
   ============================================================ */

function showTokenRefreshedBadge() {
    const badge = document.getElementById("tokenRefreshedBadge");
    if (!badge) return;

    // Generate random vibrant color
    const colors = ["#28a745", "#17a2b8", "#ffc107", "#fd7e14", "#dc3545", "#6610f2"];
    const color = colors[Math.floor(Math.random() * colors.length)];

    badge.style.backgroundColor = color;
    badge.style.display = "inline-block";

    // Add small animation
    badge.style.opacity = "1";
    badge.style.transform = "scale(1.05)";

    setTimeout(() => {
        badge.style.opacity = "0.9";
        badge.style.transform = "scale(1)";
    }, 200);
}


</script>

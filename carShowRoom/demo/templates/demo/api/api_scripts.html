<script>
/* ============================================================
   UTIL: Determine which response panel to show
   ============================================================ */
function getTargetByEndpoint(endpoint) {
    if (endpoint.startsWith('/api/customers/')) return 'customersResponse';
    if (endpoint.startsWith('/api/cars/')) return 'carsResponse';
    if (endpoint.startsWith('/api/orders/')) return 'ordersResponse';
    return null;
}

function showResponse(targetId, data, status = 200) {
    const pre = document.getElementById(targetId);
    if (!pre) return;

    pre.textContent = "HTTP " + status + "\n\n" + JSON.stringify(data, null, 4);
}

/* ============================================================
   TOKEN HANDLING
   ============================================================ */
function setTokenFrom(access, refresh = null) {
    const tokenDisplay = document.getElementById('activeToken');

    if (!access) {
        tokenDisplay.textContent = "Bearer demo-token-123 (no token)";
        return;
    }

    tokenDisplay.textContent = "Bearer " + access;

    // save to localStorage
    localStorage.setItem('api_demo_access', access);
    if (refresh) localStorage.setItem('api_demo_refresh', refresh);
}

function copyToken() {
    navigator.clipboard.writeText(document.getElementById('activeToken').textContent);
    alert("Token copied to clipboard");
}

function clearToken() {
    setTokenFrom(null);
    localStorage.removeItem('api_demo_access');
    localStorage.removeItem('api_demo_refresh');
}

function useDemoToken() {
    setTokenFrom("demo-token-123");
}



/* ============================================================
   AUTH: Obtain JWT token
   ============================================================ */
async function obtainToken() {
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;

    const res = await fetch("/api/token/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (res.ok) {
        setTokenFrom(data.access, data.refresh || null);
        alert("Token obtained.");
    } else {
        alert("Login failed: " + JSON.stringify(data));
    }
}

/* ============================================================
   AUTH: Refresh Token
   ============================================================ */
async function refreshToken() {
    const refresh = document.getElementById("refreshTokenInput").value;
    if (!refresh) return alert("Paste refresh token first.");

    const res = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
    });

    const data = await res.json();

    if (res.ok) {
        setTokenFrom(data.access, data.refresh || null);
        alert("Token refreshed.");
    } else {
        alert("Refresh failed: " + JSON.stringify(data));
    }
}


/* ============================================================
   UTIL: Build request headers
   ============================================================ */
function getAuthHeaders() {
    const headers = { "Content-Type": "application/json" };
    const token = document.getElementById("activeToken").textContent;

    if (token.startsWith("Bearer ") && !token.includes("(no token)")) {
        headers["Authorization"] = token;
    }
    return headers;
}



/* ============================================================
   GENERIC API CALL
   ============================================================ */
async function tryApi(method, endpoint, body = null, overrideTarget = null) {
    const headers = getAuthHeaders();

    const res = await fetch(endpoint, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
    });

    let data;
    try {
        data = await res.json();
    } catch {
        data = { error: "Non-JSON response" };
    }

    const target = overrideTarget || getTargetByEndpoint(endpoint);
    if (target) showResponse(target, data, res.status);

    return { ok: res.ok, status: res.status };
}


/* ============================================================
   API CALL WITH ID
   ============================================================ */
function tryApiWithId(method, base, id, suffix = '/') {
    if (!id) return alert("Please provide an ID");
    const endpoint = base + id + suffix;
    return tryApi(method, endpoint);
}

/* ============================================================
   CUSTOMERS: Create
   ============================================================ */
async function createCustomer() {
    const body = {
        name: document.getElementById("cust_name").value,
        email: document.getElementById("cust_email").value,
        phone: document.getElementById("cust_phone").value,
    };
    await tryApi("POST", "/api/customers/", body);
}

async function getCustomersIds() {
    await tryApi("GET", "/api/customers/");
}

/* ============================================================
   CARS: Create
   ============================================================ */
async function createCar() {
    const body = {
        name: document.getElementById("car_name").value,
        price: parseFloat(document.getElementById("car_price").value || 0),
        status: document.getElementById("car_status").value
    };

    await tryApi("POST", "/api/cars/", body);
}


/* ============================================================
   ORDERS: Create
   ============================================================ */
async function createOrder() {
    let items;
    try {
        items = JSON.parse(document.getElementById("order_items").value);
    } catch {
        return alert("Items must be valid JSON");
    }

    const body = {
        customer: document.getElementById("order_customer").value,
        items: items,
        total: parseFloat(document.getElementById("order_total").value || 0),
    };

    await tryApi("POST", "/api/orders/", body);
}

/* ============================================================
   EDIT (PUT) MODAL: Open modal with dynamic fields
   ============================================================ */
async function openEditModalFor(base, id) {
    if (!id) return alert("Please enter ID first");

    const endpoint = base + id + "/";

    // Fetch existing resource
    const res = await fetch(endpoint, { headers: getAuthHeaders() });
    const data = await res.json();

    // Build form fields dynamically
    const container = document.getElementById("editFields");
    container.innerHTML = ""; // clear

    Object.entries(data).forEach(([key, value]) => {
        // skip nested objects
        if (typeof value === "object" && value !== null) return;

        const type = typeof value === "number" ? "number" : "text";
        container.innerHTML += `
            <div class="mb-2">
                <label class="form-label">${key}</label>
                <input class="form-control"
                       data-key="${key}"
                       type="${type}"
                       value="${value ?? ''}" />
            </div>
        `;
    });

    // set hidden fields
    document.getElementById("edit_endpoint").value = base;
    document.getElementById("edit_id").value = id;

    // show modal
    const modal = new bootstrap.Modal(document.getElementById("editModal"));
    modal.show();
}

</script>
